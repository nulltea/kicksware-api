image:
    name: docker/compose:1.25.0
    entrypoint: [""]

services:
    - docker:stable-dind

stages:
    - init
    - build
    - test
    - deploy

before_script: &common-before
    - docker version
    - docker-compose version
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - export SOURCE_DIR="/source/repos/$CI_PROJECT_NAME"
    - apk add make

#---init stage---#

init-source-step:
  stage: init
  tags:
    - init
  script:
    - cp -r /builds/root/* /source/repos/

#----------------#

#---build stage---#


#----------------#

#---test stage---#

# test-sonar-step:
#    stage: test
#    image:
#      name: sonarsource/sonar-scanner-cli:latest
#      entrypoint: [""]
#    tags:
#      - test
#    variables:
#      SONAR_TOKEN: "8d26b9c30a611a96a53eb1f6e30326a17e186a83"
#      SONAR_HOST_URL: "http://test.kicksware.com:9000"
#      GIT_DEPTH: 0
#    script:
#      - sonar-scanner -Dsonar.qualitygate.wait=true
#    allow_failure: true
#    only:
#      - merge_requests
#      - master

#----------------#

#---deploy stage---#


deploy-api-step:
    stage: deploy
    before_script:
      - *common-before
      - export DYNAMIC_ENV_VAR=PROD
      - make mongo-backup
    tags:
      - middleware
      - deploy
    script:
      - echo setting up env $DYNAMIC_ENV_VAR
      - make middleware
    after_script:
      - make mongo-restore

#----------------#
