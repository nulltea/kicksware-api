image:
    name: docker/compose:1.25.0
    entrypoint: [""]

services:
    - docker:stable-dind

stages:
    - build
    - test
    - deploy

before_script:
    - docker version
    - docker-compose version
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - export IMAGE=$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME
    - export MIDDLEWARE_IMAGE=$IMAGE:middleware

step-middleware-deploy:
    stage: deploy
    before_script:
    - export DYNAMIC_ENV_VAR=DEVELOP
    - echo ${CI_PROJECT_DIR}
    - ls -s
    - ls ${CI_PROJECT_DIR} -s
    - ls ${CI_PROJECT_DIR}/middleware-service/ -s
    - ls ../ -s
    tags:
      - middleware
      - deploy
    script:
      - echo setting up env $DYNAMIC_ENV_VAR
      - docker-compose -f middleware-service/docker-compose.yml down
      - docker-compose -f middleware-service/docker-compose.yml build
      - docker-compose -f middleware-service/docker-compose.yml up -d



