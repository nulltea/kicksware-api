image: docker:latest
services:
  - docker:stable-dind

stages:
    - test
    - deploy

before_script:
    - apk update && apk add bash && apk add git && apk add gcc
    - docker version
    - docker-compose version
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker info

step-middleware-deploy:
    stage: deploy
    before_script:
    - export DYNAMIC_ENV_VAR=DEVELOP
    tags:
      - middleware
      - deploy
    script:
      - echo setting up env $DYNAMIC_ENV_VAR
      - apk update
      - apk upgrade
      - apk add python python-dev py-pip build-base libffi-dev openssl-dev libgcc
      - pip install docker-compose --no-cache
      - docker image prune -f
      - docker-compose -f middleware-service/docker-compose.yml down
      - docker-compose -f middleware-service/docker-compose.yml build
      - docker-compose -f middleware-service/docker-compose.yml up -d
    
